+++
type = "rivanna"
categories = [
  "HPC",
  "software",
  "bio"
]
date = "2019-06-22T08:37:46-05:00"
tags = [
  "multi-core",
]
draft = false
modulename = "smrtlink"
softwarename = "SmrtLink"
title = "SmrtLink on Rivanna"
author = "RC Staff"
+++

# Description
{{% module-description %}}
<br>
**Software Category:** {{% module-category %}}

For detailed information, visit the [{{% software-name %}} website]({{< module-homepage >}}).

# Available Versions
To find the available versions and learn how to load them, run:
```
module spider {{% module-name %}}
```

The output of the command shows the available {{% software-name %}} module versions.

For detailed information about a particular {{% software-name %}} module, including how to load the module, run the `module spider` command with the module's full version label. __For example__:
```
module spider {{% module-firstversion %}}
```

{{< module-versions >}}

# Using SmrtLink
On Rivanna, Smrtlink tools can be executed only in non-interactive mode without any graphical user interface.  Several Smrtlink tools support code execution on multiple cpu cores. Some of the common tools include [blasr](#running-blasr), [ngmlr](#running-ngmlr), [pbalign](#running-pbalign), and the `pbsv` (pbsv align and pbsv call) commands.

In the Slurm job scripts the number of requested cpu cores (per task) is stored in the envrionment variable `SLURM_CPUS_PER_TASK`.

# PacBio BAM files
The BAM format is a binary compressed format for raw or aligned sequence reads. The associated SAM format is a text representation of the same data ([specifications for BAM/SAM](http://samtools.github.io/hts-specs/SAMv1.pdf)).

PacBio-produced BAM files are a fully compatible extension of the BAM specification. In addition to the typical BAM headers, the PacBio BAM header includes `@RG` (read group) entries with the follwing tags: `ID`, `PL`, `PM`, `PU`, `DS`.  **This means that any of the Smrtlink tools that require a PacBio BAM file will not accept any generic BAM files (i.e. non-PacBio BAM files).**

A more detailed description of the PacBio BAM fomat can be found [here](https://pacbiofileformats.readthedocs.io/en/13.0/BAM.html).

# Running blasr
`blasr` is a read mapping program that maps reads to positions in a genome by clustering short exact matches between the read and the genome, and scoring clusters using alignment. The matches are generated by searching all suffixes of a read against the genome using a suffix array. When suffix array index of a genome is not specified, the suffix array is built before producing alignment. This may be prohibitively slow when the genome is large (e.g. Human). It is best to precompute the suffix array of a genome using the program [sawriter](#running-sawriter), and then specify the suffix array on the command line using `-sa genome.fa.sa`. Global chaining methods are used to score clusters of matches.

**Command line arguments**

The only required inputs to blasr are a file of reads (Fasta, PacBio BAM, bax.h5) and a reference genome (Fasta format). Although reads may be input in FASTA format, the recommended input is PacBio BAM files because these contain quality value information that is used in the alignment and produce higher quality variant detection.

* `--out` : specifies the output file. Although alignments can be output in various formats, the recommended output format is PacBio BAM using the --bam option.
* `--nproc`  : sets the number of threads used and is matched to the number of cpu cores requested for the Slurm job.

To get a more complete description of all available command line options run this command:
```
blasr --help
```

**Slurm script example**

{{< pull-code file="/static/scripts/smrtlink_blasr.slurm" lang="no-hightlight" >}}

# Running pbalign
`pbalign` maps PacBio sequences to references using predefined and selectable alignment algorithms (options are [blasr](#running-blasr), bowtie, or gmap).  The input can be a fasta, pls.h5, bas.h5 or ccs.h5 file or a fofn (file of file names).  The output can be in SAM or BAM format.  If the output is in BAM format, the aligner has to be blasr and QVs will be loaded automatically.

**Command line arguments**

pbalign expects a minimum of three command line arguments: the name of the sequence input file (set of subreads or unaligned sequences in PacBio BAM format), the path to the reference files (Fasta format), and a filename for the computed alignment results. The blasr algorithm is used by default.

+ `--nproc` : Is used to specify how many cpu cores are availabe for the alignment computation. This value is matched to the number of requested cpu core via the SLURM_CPUS_PER_TASK environment variable.

To get a more complete description of all available command line options run this command:
```
pbalign --help
```
**Slurm script example**

{{< pull-code file="/static/scripts/smrtlink_pbalign.slurm" lang="no-hightlight" >}}

# Running ngmlr
`ngmlr` is a long-read mapper designed to align PacBio or Oxford Nanopore reads to a reference genome. It is optimized for structural variation detection.

**Command line arguments**

ngmlr requires these command line arguments:

+ `-r` :  Specifies the path to the reference genome (FASTA/Q, can be gzipped)
+ `-q` :  Specifies the path to the read file (FASTA/Q) [/dev/stdin]
+ `-o` :  Specifies the path to output file [stdout]
+ `-t` :  Is used to specify how many cpu cores are availabe for the alignment computation. This value is matched to the number of requested cpu core via the SLURM_CPUS_PER_TASK environment variable.

To get a more complete description of all available command line options run this command:
```
ngmlr --help
```
**Slurm script example**

{{< pull-code file="/static/scripts/smrtlink_ngmlr.slurm" lang="no-hightlight" >}}

# Running sawriter
`sawriter` creates a suffix array from a single or list Fasta input files for a reference genome. The suffix array provides an additional index that increases the performance during the mapping step (e.g. via [blasr](#running-blasr)). This is particulalry useful when handling large reference files (i.e. larger than bacterial genomes).

**Command line arguments**

sawriter expects at least two command line arguments. The first one specifies the output file, e.g. sa_outputfile, the remaining ones specify the input files in Fasta format. At least one Fasta file has to be provided. Multiple input files can be specified by providing additional Fasta files separated by a whitespace at the end of the command.

To get a more complete description of all available command line options run this command:
```
sawriter --help
```
**Slurm script example**

{{< pull-code file="/static/scripts/smrtlink_sawriter.slurm" lang="no-hightlight" >}}
